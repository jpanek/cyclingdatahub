{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">

    <!-- Buttons previous / next -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            {% if prev_id %}
                <a href="/activity/{{ prev_id }}" class="btn btn-outline-secondary shadow-sm">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
            {% else %}
                <button class="btn btn-outline-secondary disabled border-0 text-muted">
                    <i class="bi bi-chevron-left"></i>
                </button>
            {% endif %}
        </div>
    
        <div>
            {% if next_id %}
                <a href="/activity/{{ next_id }}" class="btn btn-outline-secondary shadow-sm">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            {% else %}
                <button class="btn btn-outline-secondary disabled border-0 text-muted">
                    <i class="bi bi-chevron-right"></i>
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Titles -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex flex-column">
            <h4 class="mb-1 fw-bold">{{ activity.name }}</h4>
            <div class="text-muted fs-5">
                <span class="badge rounded-pill bg-light text-dark border">{{ activity.type }}</span>
            </div>
            <div class="text-muted fs-5">
                {{ activity.start_date_local.strftime('%A, %B %d, %Y') }} 
                <span class="text-dark">at {{ activity.start_date_local.strftime('%H:%M') }}</span>
            </div>
        </div>
    </div>

    <!-- Ride summary numbers -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <strong>Distance</strong>
                <span>{{ "%.1f"|format(activity.distance_km | default(0, true)) }} km</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <strong>Avg Power</strong>
                <span>{{ (activity.average_watts | default(0, true)) | round | int }} W</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <strong>Avg HR</strong>
                <span>{{ (activity.average_heartrate | default(0, true)) | round | int }} bpm</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <strong>Elevation</strong>
                <span>{{ (activity.total_elevation_gain | default(0, true)) | round | int }} m</span>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card shadow-sm p-3">
        <canvas id="rideChart" style="width: 100%; height: 500px;"></canvas>
    </div>


<!-- Calulated power numbers -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Power Metrics</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted d-block small">Weighted Avg Power</label>
                    <span class="fs-3 fw-bold text-primary">{{ activity.weighted_avg_power or 0 }} W</span>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="text-muted d-block small">Variability (VI)</label>
                        <span class="fs-5 fw-bold">{{ "%.2f"|format(activity.variability_index or 1.0) }}</span>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="text-muted d-block small">Intensity (IF)</label>
                        <span class="fs-5 fw-bold">{{ "%.2f"|format(activity.intensity_score or 0.0) }}</span>
                    </div>
                    <div class="col-12">
                        <label class="text-muted d-block small">Aerobic Decoupling</label>
                        <span class="fs-5 fw-bold {% if activity.aerobic_decoupling and activity.aerobic_decoupling > 5 %}text-danger{% else %}text-success{% endif %}">
                            {{ "%.1f"|format(activity.aerobic_decoupling or 0.0) }}%
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Best efforts (Interval Averages)</div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">Interval</th>
                            <th>Avg Power</th>
                            <th>Avg HR (at Peak Power)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for label in ['5s', '1m', '5m', '20m'] %}
                        <tr>
                            <td class="ps-3 fw-semibold">{{ '5 Seconds' if label == '5s' else label.replace('m', ' Minute').replace('20 Minute', '20 Minutes') }}</td>
                            <td class="fw-bold">{{ activity.interval_bests[label]['power'] or '-' }} W</td>
                            <td class="text-danger">{{ activity.interval_bests[label]['hr'] or '-' }} bpm</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('rideChart').getContext('2d');
    
    // Injecting the streams from Flask/Python to JS
    const timeData = {{ activity.time_series | tojson }};
    const powerData = {{ activity.watts_series | tojson }};
    const hrData = {{ activity.heartrate_series | tojson }};
    const cadenceData = {{ activity.cadence_series |tojson }}

    // Helper to convert seconds to HH:MM:SS for the X-axis
    const formatTime = (seconds) => {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return [h, m, s].map(v => v < 10 ? "0" + v : v).join(":");
    };

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timeData.map(formatTime),
            datasets: [
                {
                    label: 'Power (W)',
                    data: powerData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 1,
                    fill: true,
                    yAxisID: 'yPower',
                    pointRadius: 0
                },
                {
                    label: 'Heart Rate (BPM)',
                    data: hrData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'yHR',
                    pointRadius: 0
                },
                {
                    label: 'Cadence (RPM)',
                    data: cadenceData,
                    borderColor: 'rgba(75, 192, 192, 1)', // Teal/Green color
                    borderWidth: 1.5,
                    fill: false,
                    yAxisID: 'yHR', // We can share the HR axis or create a new 'yCadence'
                    pointRadius: 0,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { display: true, title: { display: true, text: 'Time' } },
                yPower: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Watts' },
                    min: 0
                },
                yHR: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'BPM' }
                }
            }
        }
    });
</script>
{% endblock %}