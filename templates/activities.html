<!-- templates/activities.html -->

{% extends "base.html" %}

{% block title %}Activities | Cycling Stats{% endblock %}


{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0 fw-bold">Activity History</h4>
            <p class="text-muted small mb-0">
                Showing <strong>{{ activities|length }}</strong> activities
            </p>
        </div>
        <div class="btn-group shadow-sm">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-download me-1"></i> Export
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item" href="{{ request.full_path }}{% if '?' in request.full_path %}&{% else %}?{% endif %}export=csv">
                        Download CSV
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{{ request.full_path }}{% if '?' in request.full_path %}&{% else %}?{% endif %}export=json">
                        Download JSON
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-0 bg-light">
        <div class="card-body">
            <form method="GET" action="/activities" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Activity Type</label>
                    <select name="type" class="form-select border-0 shadow-sm">
                        <option value="">All Types</option>
                        {% for row in activity_types %}
                        <option value="{{ row.type }}" {% if row.type == current_type %}selected{% endif %}>
                            {{ row.type }} ({{ row.activity_count }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">From</label>
                    <input type="date" name="from" class="form-control border-0 shadow-sm" value="{{ since_date }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">To</label>
                    <input type="date" name="to" class="form-control border-0 shadow-sm" value="{{ until_date }}">
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1 shadow-sm">Filter</button>
                    <a href="/activities" class="btn btn-white border shadow-sm text-decoration-none text-dark">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3">Date</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Distance</th>
                        <th>Duration</th>
                        <th>Power</th>
                        <th>TSS</th>
                        <th>HR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for act in activities %}
                    <tr 
                        {% if not act.streams_missing %}
                            class="activity-row-clickable"
                            style="cursor: pointer;" 
                            onclick="window.location='/activity/{{ act.strava_id }}'"
                        {% else %}
                            class="text-muted opacity-50"
                            style="cursor: default;"
                        {% endif %}
                    >
                        <td class="ps-3 text-nowrap">
                            {{ act.start_datetime.strftime('%d %b %Y') if act.start_datetime else '-' }}
                        </td>
                        <td class="fw-semibold text-truncate" style="max-width: 150px;" title="{{ act.name }}">
                            {{ act.name }}
                            {% if act.streams_missing %}
                                <small class="fw-normal" style="font-size: 0.7rem;">(Summary Only)</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge rounded-pill bg-white text-dark border fw-normal">
                                {{ act.type }}
                            </span>
                        </td>
                        <td>{{ "{:,.1f}".format(act.distance_km | default(0)) }} km</td>
                        <td>
                            {% set total_seconds = (act.duration_hours | default(0) * 3600) | int %}
                            {% set hrs = total_seconds // 3600 %}
                            {% set mins = (total_seconds % 3600) // 60 %}
                            
                            {% if hrs > 0 %}
                                {{ hrs }}h {{ "{:02d}".format(mins) }}m
                            {% else %}
                                {{ mins }}m
                            {% endif %}
                        </td>
                        <td>
                            {{ (act.average_watts | default(0)) | int }} W
                        </td>
                        <td>
                            {{ (act.tss | default(0)) | int }}
                        </td>
                        <td>{{ (act.average_heartrate | default(0)) | int }} bpm</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-search d-block mb-2 fs-4"></i>
                            No activities found for the selected criteria.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <style>
        /* Only apply hover highlight to clickable rows */
        .activity-row-clickable:hover {
            background-color: #f8f9fa !important;
        }
    </style>


</div>
{% endblock %}