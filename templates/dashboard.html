<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Dashboard - Cycling Stats{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Activity history</h1>
        <p class="text-muted">Monthly trends of all activities.</p>
    </div>
</div>

<!-- Slicers & selectors -->
<div class="d-flex flex-wrap gap-2 mb-4 align-items-center dashboard-controls">
    
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-custom active metric-btn" 
                onclick="setMetric('distance_km', 'Distance (km)', 'rgba(74, 85, 104, 0.6)')">Distance</button>
        <button type="button" class="btn btn-outline-custom metric-btn" 
                onclick="setMetric('activities', 'Activity Count', 'rgba(107, 114, 128, 0.6)')">Count</button>
        <button type="button" class="btn btn-outline-custom metric-btn" 
                onclick="setMetric('duration_hours', 'Time (hrs)', 'rgba(113, 128, 150, 0.6)')">Time</button>
        <button type="button" class="btn btn-outline-custom metric-btn" 
                onclick="setMetric('total_kj', 'Energy (kJ)', 'rgba(160, 174, 192, 0.6)')">Energy</button>
    </div>

    <div class="dropdown" style="min-width: 200px;">
        <button class="btn btn-outline-custom dropdown-toggle w-100 text-start" type="button" id="typeDropdown" data-bs-toggle="dropdown">
            Activity Types
        </button>
        <ul class="dropdown-menu p-3 custom-dropdown-menu" aria-labelledby="typeDropdown" style="max-height: 400px; overflow-y: auto;">
            <li class="d-flex justify-content-between mb-2">
                <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none text-muted" 
                        onclick="bulkSelect(true, event)">Select All</button>
                <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none text-danger opacity-75" 
                        onclick="bulkSelect(false, event)">Deselect All</button>
            </li>
            <li><hr class="dropdown-divider"></li>
            
            {% for row in activity_types %}
            <li>
                <div class="form-check">
                    <input class="form-check-input type-checkbox" type="checkbox" 
                           value="{{ row.type }}" 
                           id="type{{ row.type }}" 
                           {% if loop.index0 < 4 %}checked{% endif %} 
                           onchange="updateDashboard()">
                    <label class="form-check-label text-muted" for="type{{ row.type }}">
                        {{ row.type }} <span class="small opacity-50">({{ row.activity_count }})</span>
                    </label>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div style="min-width: 160px;">
        <select id="rangeSelector" class="form-select form-select-custom" onchange="updateDashboard()">
            <option value="6">Last 6 Months</option>
            <option value="12" selected>Last Year</option>
            <option value="24">Last 2 Years</option>
            <option value="36">Last 3 Years</option>
            <option value="0">Full History</option>
        </select>
    </div>
</div>

<!-- Summary tiles -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="p-3 border rounded bg-white shadow-sm">
            <div class="text-muted small text-uppercase fw-bold">Activities</div>
            <div id="stat-count" class="h4 mb-0 fw-bold">0</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="p-3 border rounded bg-white shadow-sm">
            <div class="text-muted small text-uppercase fw-bold">Distance</div>
            <div id="stat-distance" class="h4 mb-0 fw-bold">0 km</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="p-3 border rounded bg-white shadow-sm">
            <div class="text-muted small text-uppercase fw-bold">Time</div>
            <div id="stat-time" class="h4 mb-0 fw-bold">0h</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="p-3 border rounded bg-white shadow-sm">
            <div class="text-muted small text-uppercase fw-bold">Energy</div>
            <div id="stat-energy" class="h4 mb-0 fw-bold">0 kJ</div>
        </div>
    </div>
</div>


<!-- Chart goes here -->
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">

            <div class="card-body">
                <canvas id="distanceChart" style="width: 100%; height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Table with data here: -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 h6 fw-bold">Table view</h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#dataTableCollapse">
                    Toggle
                </button>
            </div>
            <div class="collapse" id="dataTableCollapse">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 small">
                            <thead class="table-light">
                                <tr id="tableHeader">
                                    </tr>
                            </thead>
                            <tbody id="tableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export buttons -->
<div class="row mt-4 mb-5">
    <div class="col d-flex justify-content-end gap-2">
        <button class="btn btn-sm btn-outline-custom border" onclick="exportCurrentView()">
            <i class="bi bi-download"></i> Export View (CSV)
        </button>
        <!--
        <button class="btn btn-sm btn-outline-custom border" onclick="exportFullHistory()">
            <i class="bi bi-database-down"></i> Full Export
        </button>
        -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
    // This is the bridge: it passes Flask data to the external JS file
    const rawData = {{ chart_data | tojson }};
    
    window.onload = function() {
        initChart();
        updateDashboard();
    };
</script>

<!-- Modal to display activities inside a month -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="modalTitle">Activities</h5>
                <div class="ms-auto d-flex align-items-center">
                    <button id="modalExportBtn" class="btn btn-sm btn-outline-custom border d-none me-3" onclick="exportModalActivities()">
                        <i class="bi bi-download"></i> Export (csv)
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div id="modalLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Fetching granular data...</p>
                </div>
                
                <div id="modalTableContainer" class="table-responsive d-none">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Date</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th class="text-end">Dist (km)</th>
                                <th class="text-end">Time (h)</th>
                                <th class="text-end pe-3">Energy (kJ)</th>
                            </tr>
                        </thead>
                        <tbody id="activityListBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}